/*  mock_websocket.js, version 0.0.1
*  (c) 2011 Ismael Celis (@ismasan)
*
*  Released under MIT license.
*/
var Sockete=function(){return{mock:function(){window.WebSocket=Sockete.Client},logEvent:function(b){if(!(window.console&&Sockete.settings.log))return false;console.log(b,"[Sockete.Response] - client "+b.currentTarget.__sockete_id+" | "+b.type+" : "+b.data)},logRound:function(b,a,c){if(!(window.console&&Sockete.settings.log))return false;console.log("[Sockete] client "+a.client.__sockete_id+":"+a.toString()+" => server "+b.URL+":"+c.toString())},settings:{connection_delay:10,log:true}}}();
(function(){Sockete.Request=function(b,a,c){this.client=b;this.request_type=a;this.message=c};Sockete.Request.prototype={toString:function(){return"[Sockete.Request] "+this.request_type+" : "+this.message}}})();(function(){Sockete.Response=function(b,a,c){this.type=a;this.data=c;this.currentTarget=b;this.toString=function(){return"["+(a=="open"?"success":"fail")+"] "+c}}})();
(function(){Sockete.clients=[];Sockete.Client=function(b){function a(d){switch(d.type){case "open":c.readyState=1;break;case "close":c.readyState=3}c["on"+d.type](d)}this.onmessage=function(d){Sockete.logEvent(d)};this.onclose=function(d){Sockete.logEvent(d)};this.onopen=function(d){Sockete.logEvent(d)};b=b;this.__server=null;this.readyState=0;var c=this;this.close=function(){c.readyState=2;var d=new Sockete.Request(c,"close");c.__server.request(d,a)};this.send=function(d){if(this.readyState!=1)return false;
d=new Sockete.Request(c,"message",d);c.__server.request(d,a);return true};setTimeout(function(){c.__server=Sockete.Server.find(b);if(!c.__server)throw"[Sockete.Client#connect] No server configured for URL "+b;var d=new Sockete.Request(c,"open");c.__server.request(d,a)},Sockete.settings.connection_delay);Sockete.clients.push(this);this.__sockete_id=Sockete.clients.length}})();
(function(){function b(a){if(a.__response_type)throw"Response for "+a.message+" has already been set to "+a.__response_type+" with "+a.__response_message;}Sockete.Responder=function(a,c){this.event_type=a;this.message=c};Sockete.Responder.prototype={__response_type:null,__response_message:null,respond:function(a){b(this);this.__response_type="message";this.__response_message=a;return this},fail:function(a){b(this);this.__response_type="close";this.__response_message=a;return this},match:function(a){return a.request_type==
this.event_type},response:function(a){return new Sockete.Response(a,this.__response_type,this.__response_message)}}})();
(function(){Sockete.Server=function(b){this.url=this.URL=b;this.responders=[]};Sockete.Server.prototype={addResponder:function(b,a){var c=new Sockete.Responder(b,a);this.responders.push(c);return c},onmessage:function(b){return this.addResponder("message",b)},onconnect:function(){return this.addResponder("open","")},request:function(b,a){var c;if(responder=this.findResponder(b))c=responder.response(b.client);else switch(b.request_type){case "open":c=new Sockete.Response(b.client,"open");break;case "close":c=
new Sockete.Response(b.client,"close");break;default:c=new Sockete.Response(b.client,"close","[Sockete.Server] No response configured for "+b.toString())}Sockete.logRound(this,b,c);a(c)},match:function(b){return b==this.url},findResponder:function(b){for(var a=0,c=this.responders.length;a<c;a++)if(this.responders[a].match(b))return this.responders[a];return null}};Sockete.servers=[];Sockete.Server.configure=function(b,a){var c=new Sockete.Server(b);a.apply(c,[]);Sockete.servers.push(c);return c};
Sockete.Server.find=function(b){for(var a=0,c=Sockete.servers.length;a<c;a++)if(Sockete.servers[a].match(b))return Sockete.servers[a];return null}})();
